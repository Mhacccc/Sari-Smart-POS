"use client";

import { create } from "zustand";
import { persist, createJSONStorage } from "zustand/middleware";
import type { Product, OrderItem } from "@/types";

interface CartState {
    items: OrderItem[];
    addItem: (product: Product, quantity?: number) => void;
    removeItem: (productId: string) => void;
    updateQuantity: (productId: string, quantity: number) => void;
    clearCart: () => void;
    getTotal: () => number;
    getItemCount: () => number;
}

export const useCartStore = create<CartState>()(
    persist(
        (set, get) => ({
            items: [],

            addItem: (product: Product, quantity = 1) => {
                set((state) => {
                    const existing = state.items.find(
                        (item) => item.product_id === product.id
                    );

                    if (existing) {
                        return {
                            items: state.items.map((item) =>
                                item.product_id === product.id
                                    ? {
                                        ...item,
                                        quantity: item.quantity + quantity,
                                        subtotal: (item.quantity + quantity) * item.unit_price,
                                    }
                                    : item
                            ),
                        };
                    }

                    const newItem: OrderItem = {
                        id: crypto.randomUUID(),
                        order_id: "", // assigned at checkout
                        product_id: product.id,
                        product_name: product.name,
                        quantity,
                        unit_price: product.price,
                        subtotal: product.price * quantity,
                    };

                    return { items: [...state.items, newItem] };
                });
            },

            removeItem: (productId: string) => {
                set((state) => ({
                    items: state.items.filter((item) => item.product_id !== productId),
                }));
            },

            updateQuantity: (productId: string, quantity: number) => {
                if (quantity <= 0) {
                    get().removeItem(productId);
                    return;
                }

                set((state) => ({
                    items: state.items.map((item) =>
                        item.product_id === productId
                            ? { ...item, quantity, subtotal: quantity * item.unit_price }
                            : item
                    ),
                }));
            },

            clearCart: () => set({ items: [] }),

            getTotal: () => {
                return get().items.reduce((sum, item) => sum + item.subtotal, 0);
            },

            getItemCount: () => {
                return get().items.reduce((sum, item) => sum + item.quantity, 0);
            },
        }),
        {
            name: "smartindahan-cart",
            storage: createJSONStorage(() => localStorage),
            // NOTE: In Phase 4, this will migrate to IndexedDB via Dexie.js
            // for full offline persistence of the transaction queue.
        }
    )
);
